<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Home Buyer Report - Melbourne 2024</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .app-layout {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 900;
            transition: transform 0.3s ease;
        }
        
        .sidebar.collapsed {
            transform: translateX(-320px);
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 25px 20px;
            position: sticky;
            top: 0;
            z-index: 901;
        }
        
        .sidebar-header h2 {
            font-size: 1.4rem;
            margin: 0 0 8px 0;
            font-weight: 600;
        }
        
        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.8;
            margin: 0;
        }
        
        .sidebar-content {
            padding: 25px 20px;
        }
        
        .sidebar-toggle {
            position: fixed;
            left: 10px;
            top: 15px;
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            font-size: 1.2rem;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-toggle:hover {
            background: white;
            transform: scale(1.05);
        }
        
        .main-content {
            flex: 1;
            margin-left: 350px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }
        
        .main-content.sidebar-collapsed {
            margin-left: 30px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .profile-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .profile-item {
            text-align: center;
        }
        
        .profile-item .label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .profile-item .value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .content {
            padding: 40px 30px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
            display: flex;
            align-items: center;
        }
        
        .section h2::before {
            content: attr(data-icon);
            margin-right: 10px;
            font-size: 1.5rem;
        }
        
        .eligibility-status {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .eligibility-status h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .schemes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .scheme-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border-left: 5px solid #3498db;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .scheme-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .scheme-card h4 {
            color: #2c3e50;
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .scheme-card .category {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .scheme-card ul {
            list-style: none;
        }
        
        .scheme-card li {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .scheme-card li::before {
            content: "‚úì";
            color: #27ae60;
            font-weight: bold;
            position: absolute;
            left: 0;
        }
        
        .borrowing-capacity {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }
        
        .borrowing-capacity h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .borrowing-capacity .amount {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 15px 0;
        }
        
        .costs-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .cost-item {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: border-color 0.2s;
        }
        
        .cost-item:hover {
            border-color: #3498db;
        }
        
        .cost-item h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .cost-item .amount {
            font-size: 1.3rem;
            font-weight: 600;
            color: #e74c3c;
        }
        
        .recommendation {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
        }
        
        .recommendation h3 {
            font-size: 1.6rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .recommendation .price-range {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
        }
        
        .recommendation p {
            font-size: 1.1rem;
            text-align: center;
            opacity: 0.95;
        }
        
        .footer {
            background: #34495e;
            color: white;
            padding: 20px 30px;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .calculator {
            background: linear-gradient(135deg, #16a085, #1abc9c);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .calculator h3 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .calculator-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .form-group {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }
        
        .calculate-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            margin: 0 auto;
        }
        
        .calculate-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .results {
            display: none;
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
        }
        
        .results.show {
            display: block;
        }
        
        .monthly-total {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .monthly-total h4 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .monthly-total .amount {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .cost-comparison {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .comparison-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            min-width: 120px;
        }
        
        .comparison-item .label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .comparison-item .value {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .cost-breakdown-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .detail-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
        }
        
        .detail-item .label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .detail-item .value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .affordability-indicator {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
        }
        
        .affordable {
            background: rgba(39, 174, 96, 0.8);
        }
        
        .marginal {
            background: rgba(243, 156, 18, 0.8);
        }
        
        .unaffordable {
            background: rgba(231, 76, 60, 0.8);
        }
        
        /* OpenRouter API Settings */
        .settings-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        
        .settings-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .settings-header h3 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: #ecf0f1;
            color: #2c3e50;
        }
        
        .settings-form-group {
            margin-bottom: 20px;
        }
        
        .settings-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .settings-form-group input, .settings-form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .settings-form-group input:focus, .settings-form-group select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .api-status {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
        }
        
        .api-status.disconnected {
            background: #fee;
            color: #c0392b;
            border: 1px solid #e74c3c;
        }
        
        .api-status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }
        
        .api-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }
        
        .settings-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .btn-secondary, .btn-primary, .btn-test {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-test {
            background: #f39c12;
            color: white;
        }
        
        .btn-test:hover {
            background: #e67e22;
        }
        
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3498db;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
            transition: all 0.3s;
            z-index: 999;
        }
        
        .settings-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        
        .ai-assistant {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .ai-assistant.disabled {
            background: #95a5a6;
            opacity: 0.7;
        }
        
        .ai-assistant h4 {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .ai-prompt-area {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 15px;
        }
        
        .ai-prompt-area:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }
        
        .ai-response {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .ai-response.show {
            display: block;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Sidebar Form Styling */
        .profile-section {
            margin-bottom: 30px;
        }
        
        .profile-section h3 {
            color: #2c3e50;
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .form-field {
            margin-bottom: 18px;
        }
        
        .form-field label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .form-field input, .form-field select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        
        .form-field input:focus, .form-field select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .form-field small {
            display: block;
            color: #7f8c8d;
            font-size: 0.8rem;
            margin-top: 4px;
        }
        
        .eligible-schemes {
            margin-top: 25px;
        }
        
        .eligible-schemes h3 {
            color: #27ae60;
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .eligible-schemes h3::before {
            content: "‚úÖ";
            margin-right: 8px;
        }
        
        .scheme-item {
            background: #f8f9fa;
            border-left: 4px solid #27ae60;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 0 6px 6px 0;
        }
        
        .scheme-item h4 {
            color: #2c3e50;
            font-size: 0.95rem;
            margin: 0 0 6px 0;
        }
        
        .scheme-item p {
            color: #7f8c8d;
            font-size: 0.85rem;
            margin: 0;
            line-height: 1.4;
        }
        
        .scheme-tag {
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 6px;
        }
        
        .no-schemes {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .profile-summary {
            background: linear-gradient(135deg, #16a085, #1abc9c);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .profile-summary h3 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            font-size: 0.85rem;
        }
        
        .profile-stats .stat-item {
            text-align: center;
        }
        
        .profile-stats .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 3px;
        }
        
        .profile-stats .stat-label {
            opacity: 0.8;
        }
        
        /* Profile Settings Accordion */
        .profile-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
            border: 2px solid #ecf0f1;
        }
        
        .profile-settings-header:hover {
            background: #e9ecef;
            border-color: #3498db;
        }
        
        .profile-settings-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1rem;
            display: flex;
            align-items: center;
        }
        
        .profile-settings-header h3::before {
            content: "‚öôÔ∏è";
            margin-right: 8px;
        }
        
        .profile-settings-toggle {
            background: none;
            border: none;
            color: #3498db;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.3s;
            padding: 5px;
        }
        
        .profile-settings-toggle.expanded {
            transform: rotate(180deg);
        }
        
        .profile-form-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
            background: #fdfdfd;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .profile-form-container.expanded {
            max-height: 800px; /* Adjust based on content */
            border: 1px solid #ecf0f1;
        }
        
        .profile-form-content {
            padding: 25px;
        }
        
        .profile-status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .profile-complete {
            background: #d4edda;
            color: #155724;
        }
        
        .profile-incomplete {
            background: #fff3cd;
            color: #856404;
        }
        
        .profile-quick-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .profile-quick-summary .summary-item {
            display: flex;
            align-items: center;
        }
        
        .profile-quick-summary .summary-item::before {
            content: "‚Ä¢";
            margin-right: 5px;
            color: #3498db;
        }
        
        .edit-profile-prompt {
            background: linear-gradient(135deg, #ff7b7b, #ff6b6b);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 25px;
        }
        
        .edit-profile-prompt h3 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }
        
        .edit-profile-prompt button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .edit-profile-prompt button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                transform: translateX(-100%);
                z-index: 1001;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .sidebar.collapsed {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .main-content.sidebar-collapsed {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                left: 15px;
                top: 20px;
                background: #3498db;
                color: white;
            }
            
            .container {
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .profile-card {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .borrowing-capacity .amount {
                font-size: 2rem;
            }
            
            .costs-breakdown {
                grid-template-columns: 1fr;
            }
            
            .calculator-form {
                grid-template-columns: 1fr;
            }
            
            .monthly-total .amount {
                font-size: 2rem;
            }
            
            .cost-comparison {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar Toggle -->
        <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Profile">üë§</button>
        
        <!-- Settings Button -->
        <button class="settings-btn" onclick="openSettings()" title="API Settings">‚öôÔ∏è</button>
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Your Profile</h2>
                <p>Configure your details to see eligible schemes</p>
            </div>
            
            <div class="sidebar-content">
                <!-- Profile Summary -->
                <div class="profile-summary" id="profile-summary">
                    <h3>Welcome!</h3>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="borrowing-estimate">$0</div>
                            <div class="stat-label">Est. Borrowing</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="schemes-count">0</div>
                            <div class="stat-label">Eligible Schemes</div>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Settings (Collapsible) -->
                <div id="profile-settings-section">
                    <!-- Header with toggle -->
                    <div class="profile-settings-header" onclick="toggleProfileSettings()">
                        <div>
                            <h3>Personal Settings</h3>
                            <div class="profile-quick-summary" id="profile-quick-summary">
                                <!-- Quick summary will be populated here -->
                            </div>
                        </div>
                        <button class="profile-settings-toggle" id="profile-settings-toggle">‚ñº</button>
                    </div>
                    
                    <!-- Collapsible form container -->
                    <div class="profile-form-container" id="profile-form-container">
                        <div class="profile-form-content">
                            <div class="profile-section">
                                <div class="form-field">
                                    <label for="citizenship">Citizenship</label>
                                    <select id="citizenship" onchange="updateProfile()">
                                        <option value="">Select citizenship</option>
                                        <option value="australian">Australian Citizen</option>
                                        <option value="permanent-resident">Permanent Resident</option>
                                        <option value="nz-citizen">New Zealand Citizen</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                
                                <div class="form-field">
                                    <label for="relationship-status">Relationship Status</label>
                                    <select id="relationship-status" onchange="updateProfile()">
                                        <option value="">Select status</option>
                                        <option value="single">Single</option>
                                        <option value="couple">Couple/Married</option>
                                        <option value="de-facto">De Facto</option>
                                    </select>
                                </div>
                                
                                <div class="form-field">
                                    <label for="annual-income">Annual Income (before tax)</label>
                                    <input type="number" id="annual-income" placeholder="90000" min="0" step="1000" onchange="updateProfile()">
                                    <small>Enter your gross annual income in AUD</small>
                                </div>
                                
                                <div class="form-field" id="partner-income-field" style="display: none;">
                                    <label for="partner-income">Partner's Annual Income</label>
                                    <input type="number" id="partner-income" placeholder="75000" min="0" step="1000" onchange="updateProfile()">
                                    <small>Enter partner's gross annual income in AUD</small>
                                </div>
                                
                                <div class="form-field">
                                    <label for="current-rent">Current Rent/Month</label>
                                    <input type="number" id="current-rent" placeholder="2000" min="0" step="50" onchange="updateProfile()">
                                    <small>Your current monthly housing cost</small>
                                </div>
                                
                                <div class="form-field">
                                    <label for="state">State/Territory</label>
                                    <select id="state" onchange="updateProfile()">
                                        <option value="">Select state</option>
                                        <option value="NSW">New South Wales</option>
                                        <option value="VIC" selected>Victoria</option>
                                        <option value="QLD">Queensland</option>
                                        <option value="SA">South Australia</option>
                                        <option value="WA">Western Australia</option>
                                        <option value="TAS">Tasmania</option>
                                        <option value="NT">Northern Territory</option>
                                        <option value="ACT">Australian Capital Territory</option>
                                    </select>
                                </div>
                                
                                <div class="form-field">
                                    <label for="first-home-buyer">First Home Buyer?</label>
                                    <select id="first-home-buyer" onchange="updateProfile()">
                                        <option value="">Select status</option>
                                        <option value="yes" selected>Yes, never owned property</option>
                                        <option value="previous-owner">Previously owned, but not in last 10 years</option>
                                        <option value="no">No, currently own or recently owned</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Eligible Schemes -->
                <div class="eligible-schemes">
                    <h3>Eligible Schemes</h3>
                    <div id="schemes-list">
                        <div class="no-schemes">
                            Complete your profile to see eligible first home buyer schemes
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <!-- Settings Overlay -->
            <div class="settings-overlay" id="settings-overlay">
                <div class="settings-modal">
                    <div class="settings-header">
                        <h3>üîß OpenRouter API Settings</h3>
                        <button class="close-btn" onclick="closeSettings()">√ó</button>
                    </div>
                    
                    <div class="settings-form-group">
                        <label for="api-key">API Key</label>
                        <input type="password" id="api-key" placeholder="Enter your OpenRouter API key">
                        <small style="color: #7f8c8d;">Get your API key from <a href="https://openrouter.ai/keys" target="_blank" style="color: #3498db;">OpenRouter Dashboard</a></small>
                    </div>
                    
                    <div class="settings-form-group">
                        <label for="app-name">App Name (Optional)</label>
                        <input type="text" id="app-name" placeholder="First Home Buyer Assistant" value="First Home Buyer Assistant">
                    </div>
                    
                    <div class="settings-form-group">
                        <label for="app-url">App URL (Optional)</label>
                        <input type="url" id="app-url" placeholder="https://your-domain.com">
                    </div>
                    
                    <div class="settings-form-group">
                        <label for="selected-model">AI Model</label>
                        <select id="selected-model">
                            <option value="">Select a model (showing free models only)</option>
                        </select>
                    </div>
                    
                    <div class="api-status disconnected" id="api-status">
                        üî¥ Disconnected - Enter API key and test connection
                    </div>
                    
                    <div class="settings-buttons">
                        <button class="btn-test" onclick="testConnection()">Test Connection</button>
                        <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
                        <button class="btn-primary" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>
            </div>
            
            <div class="container">
                <header class="header">
                    <h1>First Home Buyer Report</h1>
                    <p class="subtitle">Australia - 2024/2025</p>
                    
                    <div style="text-align: center; padding: 20px 0;">
                        <p style="font-size: 1.1rem; opacity: 0.9;">Configure your profile in the sidebar to see personalized schemes and recommendations</p>
                    </div>
                </header>
        
        <main class="content">
            <section class="section">
                <div id="profile-status">
                    <!-- Dynamic content based on user profile -->
                </div>
            </section>
            
            
            
            
            <section class="section">
                <h2 data-icon="üßÆ">Property Calculator</h2>
                <div class="calculator">
                    <h3>Calculate Total Monthly Ownership Costs</h3>
                    <p style="text-align: center; margin-bottom: 25px; opacity: 0.9;">Enter property details manually or paste a property URL to auto-populate costs</p>
                    
                    <!-- Property URL Section -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px; margin-bottom: 25px;">
                        <h4 style="margin-bottom: 15px; font-size: 1.2rem;">üîó Auto-Fill from Property Listing</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="url" id="property-url" placeholder="Paste property URL from realestate.com.au, domain.com.au, etc." style="flex: 1; min-width: 300px; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #2c3e50; font-size: 1rem;">
                            <button onclick="fetchPropertyDetails()" id="fetch-btn" style="padding: 12px 20px; background: #e67e22; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Auto-Fill Property
                            </button>
                        </div>
                        <div id="property-fetch-status" style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;"></div>
                    </div>
                    
                    <div class="calculator-form">
                        <div class="form-group">
                            <label for="property-price">Property Price ($)</label>
                            <input type="number" id="property-price" placeholder="e.g. 650000" min="0" step="1000">
                            <small style="opacity: 0.8; font-size: 0.85rem;">Auto-populated from URL or enter manually</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="deposit-percent">Deposit (%)</label>
                            <select id="deposit-percent">
                                <option value="2">2% (Help to Buy)</option>
                                <option value="5" selected>5% (First Home Guarantee)</option>
                                <option value="10">10%</option>
                                <option value="20">20%</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="interest-rate">Interest Rate (%)</label>
                            <input type="number" id="interest-rate" value="6.5" min="1" max="15" step="0.1">
                        </div>
                        
                        <div class="form-group">
                            <label for="loan-term">Loan Term (years)</label>
                            <select id="loan-term">
                                <option value="25">25</option>
                                <option value="30" selected>30</option>
                                <option value="35">35</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="property-type">Property Type</label>
                            <select id="property-type">
                                <option value="house">House</option>
                                <option value="apartment" selected>Apartment/Unit</option>
                                <option value="townhouse">Townhouse</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="property-address">Property Address</label>
                            <input type="text" id="property-address" placeholder="e.g. 123 Collins St, Melbourne VIC 3000">
                            <small style="opacity: 0.8; font-size: 0.85rem;">Used for council rates and insurance lookup</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="strata-fees">Strata Fees ($/quarter)</label>
                            <input type="number" id="strata-fees" placeholder="e.g. 1500" min="0" step="100">
                            <small style="opacity: 0.8; font-size: 0.85rem;">Auto-estimated or enter manually</small>
                        </div>
                    </div>
                    
                    <button class="calculate-btn" onclick="calculateCosts()">Calculate Monthly Costs</button>
                    
                    <div class="results" id="results">
                        <div class="monthly-total">
                            <h4>Total Monthly Cost</h4>
                            <div class="amount" id="total-monthly">$0</div>
                        </div>
                        
                        <div class="cost-comparison">
                            <div class="comparison-item">
                                <div class="label">Current Rent</div>
                                <div class="value">$2,000</div>
                            </div>
                            <div class="comparison-item">
                                <div class="label">Difference</div>
                                <div class="value" id="difference">$0</div>
                            </div>
                        </div>
                        
                        <div class="cost-breakdown-details">
                            <div class="detail-item">
                                <div class="label">Loan Repayment</div>
                                <div class="value" id="loan-payment">$0</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">Council Rates</div>
                                <div class="value" id="council-rates">$0</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">Home Insurance</div>
                                <div class="value" id="insurance">$0</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">Strata Fees</div>
                                <div class="value" id="strata">$0</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">Maintenance</div>
                                <div class="value" id="maintenance">$0</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">Stamp Duty Saved</div>
                                <div class="value" id="stamp-duty">$0</div>
                            </div>
                        </div>
                        
                        <div class="affordability-indicator" id="affordability">
                            Assessment will appear here
                        </div>
                    </div>
                    
                    <!-- AI Assistant Integration -->
                    <div class="ai-assistant disabled" id="ai-assistant">
                        <h4>ü§ñ AI Property Analysis</h4>
                        <p style="margin-bottom: 15px; opacity: 0.9;">Get personalized insights about this property from AI</p>
                        <textarea class="ai-prompt-area" id="ai-prompt" placeholder="Ask about this property... e.g., 'Is this a good investment?', 'What are the pros and cons?', 'Should I consider this property given my situation?'" disabled></textarea>
                        <button class="calculate-btn" onclick="askAI()" disabled id="ai-ask-btn">Configure API in Settings First</button>
                        <div class="ai-response" id="ai-response"></div>
                    </div>
                </div>
            </section>

            <section class="section">
                <h2 data-icon="üéØ">Your Personalized Strategy</h2>
                <div id="cost-neutral-analysis">
                    <!-- Dynamic cost-neutral analysis content -->
                </div>
            </section>
            
            <footer class="footer">
                <p>Report generated on August 25, 2024 ‚Ä¢ Data based on current government schemes and market conditions</p>
            </footer>
        </main>
        
        </div> <!-- container -->
    </main> <!-- main-content -->
</div> <!-- app-layout -->

    <script>
        function calculateCosts() {
            // Get input values
            const propertyPrice = parseFloat(document.getElementById('property-price').value) || 0;
            const depositPercent = parseFloat(document.getElementById('deposit-percent').value) || 5;
            const interestRate = parseFloat(document.getElementById('interest-rate').value) || 6.5;
            const loanTermYears = parseFloat(document.getElementById('loan-term').value) || 30;
            const propertyType = document.getElementById('property-type').value;
            const strataFeesQuarterly = parseFloat(document.getElementById('strata-fees').value) || 0;
            
            if (propertyPrice <= 0) {
                alert('Please enter a valid property price');
                return;
            }
            
            // Calculate loan details
            const depositAmount = propertyPrice * (depositPercent / 100);
            const loanAmount = propertyPrice - depositAmount;
            const monthlyRate = interestRate / 100 / 12;
            const totalPayments = loanTermYears * 12;
            
            // Calculate monthly loan payment using PMT formula
            const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, totalPayments)) / 
                                 (Math.pow(1 + monthlyRate, totalPayments) - 1);
            
            // Calculate other monthly costs
            const councilRatesMonthly = 200; // Average $2,400/year
            const insuranceMonthly = 165; // Average $2,000/year
            const strataMonthly = strataFeesQuarterly / 3; // Convert quarterly to monthly
            const maintenanceMonthly = (propertyPrice * 0.015) / 12; // 1.5% of property value annually
            
            // Calculate stamp duty savings
            let stampDutySavings = 0;
            if (propertyPrice <= 600000) {
                stampDutySavings = calculateStampDuty(propertyPrice);
            } else if (propertyPrice <= 750000) {
                const fullDuty = calculateStampDuty(propertyPrice);
                const concession = Math.max(0, (750000 - propertyPrice) / 150000);
                stampDutySavings = fullDuty * concession;
            }
            
            // Total monthly cost
            const totalMonthly = monthlyPayment + councilRatesMonthly + insuranceMonthly + 
                               strataMonthly + maintenanceMonthly;
            
            // Update results
            document.getElementById('total-monthly').textContent = `$${Math.round(totalMonthly).toLocaleString()}`;
            document.getElementById('loan-payment').textContent = `$${Math.round(monthlyPayment).toLocaleString()}`;
            document.getElementById('council-rates').textContent = `$${councilRatesMonthly}`;
            document.getElementById('insurance').textContent = `$${insuranceMonthly}`;
            document.getElementById('strata').textContent = `$${Math.round(strataMonthly)}`;
            document.getElementById('maintenance').textContent = `$${Math.round(maintenanceMonthly)}`;
            document.getElementById('stamp-duty').textContent = `$${Math.round(stampDutySavings).toLocaleString()}`;
            
            // Calculate difference from current rent
            const difference = totalMonthly - 2000;
            const differenceEl = document.getElementById('difference');
            differenceEl.textContent = `${difference >= 0 ? '+' : ''}$${Math.round(difference).toLocaleString()}`;
            differenceEl.style.color = difference > 0 ? '#e74c3c' : '#27ae60';
            
            // Affordability assessment
            const affordabilityEl = document.getElementById('affordability');
            if (difference <= 200) {
                affordabilityEl.className = 'affordability-indicator affordable';
                affordabilityEl.textContent = '‚úÖ Highly Affordable - Similar or lower cost than current rent';
            } else if (difference <= 500) {
                affordabilityEl.className = 'affordability-indicator marginal';
                affordabilityEl.textContent = '‚ö†Ô∏è Moderately Higher - Consider your budget carefully';
            } else {
                affordabilityEl.className = 'affordability-indicator unaffordable';
                affordabilityEl.textContent = '‚ùå Significantly Higher - May strain your budget';
            }
            
            // Show results
            document.getElementById('results').classList.add('show');
            
            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }
        
        function calculateStampDuty(propertyValue) {
            // Victoria stamp duty calculation
            if (propertyValue <= 25000) return 1.4 * (propertyValue / 100);
            if (propertyValue <= 130000) return 350 + 2.4 * ((propertyValue - 25000) / 100);
            if (propertyValue <= 960000) return 2870 + 6 * ((propertyValue - 130000) / 100);
            return 52670 + 6.5 * ((propertyValue - 960000) / 100);
        }
        
        // Auto-calculate strata fees based on property type
        document.getElementById('property-type').addEventListener('change', function() {
            const strataField = document.getElementById('strata-fees');
            if (this.value === 'house') {
                strataField.value = '0';
                strataField.disabled = true;
            } else {
                strataField.disabled = false;
                if (!strataField.value || strataField.value === '0') {
                    strataField.value = this.value === 'apartment' ? '1500' : '1000';
                }
            }
        });
        
        // Initialize strata fees based on default selection
        document.getElementById('property-type').dispatchEvent(new Event('change'));
        
        // OpenRouter API Integration
        let apiConfig = {
            apiKey: '',
            appName: 'First Home Buyer Assistant',
            appUrl: '',
            selectedModel: '',
            isConnected: false,
            availableModels: []
        };
        
        // Load saved settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('openrouter-settings');
            if (saved) {
                apiConfig = { ...apiConfig, ...JSON.parse(saved) };
                document.getElementById('api-key').value = apiConfig.apiKey;
                document.getElementById('app-name').value = apiConfig.appName;
                document.getElementById('app-url').value = apiConfig.appUrl;
                document.getElementById('selected-model').value = apiConfig.selectedModel;
                
                if (apiConfig.apiKey && apiConfig.isConnected) {
                    updateConnectionStatus('connected', 'üü¢ Connected');
                    enableAIAssistant();
                }
            }
        }
        
        // Save settings to localStorage
        function saveSettings() {
            apiConfig.apiKey = document.getElementById('api-key').value;
            apiConfig.appName = document.getElementById('app-name').value;
            apiConfig.appUrl = document.getElementById('app-url').value;
            apiConfig.selectedModel = document.getElementById('selected-model').value;
            
            localStorage.setItem('openrouter-settings', JSON.stringify(apiConfig));
            closeSettings();
            
            if (apiConfig.isConnected) {
                enableAIAssistant();
            }
        }
        
        // Open settings modal
        function openSettings() {
            document.getElementById('settings-overlay').classList.add('show');
        }
        
        // Close settings modal
        function closeSettings() {
            document.getElementById('settings-overlay').classList.remove('show');
        }
        
        // Update connection status display
        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('api-status');
            statusEl.className = `api-status ${status}`;
            statusEl.textContent = message;
        }
        
        // Test API connection
        async function testConnection() {
            const apiKey = document.getElementById('api-key').value;
            if (!apiKey.trim()) {
                alert('Please enter your OpenRouter API key');
                return;
            }
            
            updateConnectionStatus('connecting', 'üü° Testing connection...');
            
            try {
                // First, test the connection by fetching available models
                const modelsResponse = await fetch('https://openrouter.ai/api/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        ...(apiConfig.appUrl && { 'HTTP-Referer': apiConfig.appUrl }),
                        ...(apiConfig.appName && { 'X-Title': apiConfig.appName })
                    }
                });
                
                if (!modelsResponse.ok) {
                    throw new Error(`HTTP ${modelsResponse.status}: ${modelsResponse.statusText}`);
                }
                
                const modelsData = await modelsResponse.json();
                apiConfig.availableModels = modelsData.data || [];
                
                // Populate model dropdown
                const modelSelect = document.getElementById('selected-model');
                modelSelect.innerHTML = '<option value="">Select a model (showing free models only)</option>';
                
                // Filter to only free models and sort by popularity/capability
                const freeModels = apiConfig.availableModels
                    .filter(model => {
                        return model.id && model.name && 
                               (model.pricing?.prompt === "0" || model.pricing?.prompt === 0 || 
                                model.id.includes('free') || 
                                !model.pricing?.prompt); // Include models without pricing data as potentially free
                    })
                    .sort((a, b) => {
                        // Prioritize known free models first
                        const aIsFree = a.id.includes('free') || a.pricing?.prompt === "0" || a.pricing?.prompt === 0;
                        const bIsFree = b.id.includes('free') || b.pricing?.prompt === "0" || b.pricing?.prompt === 0;
                        if (aIsFree && !bIsFree) return -1;
                        if (bIsFree && !aIsFree) return 1;
                        return a.name.localeCompare(b.name);
                    });
                    
                // If no free models found, show a few basic models anyway
                const popularModels = freeModels.length > 0 ? freeModels : 
                    apiConfig.availableModels
                        .filter(model => model.id && model.name)
                        .slice(0, 10); // Show first 10 models as fallback
                
                popularModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = `${model.name} (${model.id})`;
                    modelSelect.appendChild(option);
                });
                
                // Add event listener for model selection changes
                modelSelect.addEventListener('change', function() {
                    apiConfig.selectedModel = this.value;
                    localStorage.setItem('openrouter-settings', JSON.stringify(apiConfig));
                });
                
                // Test with a simple completion
                const testResponse = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        ...(apiConfig.appUrl && { 'HTTP-Referer': apiConfig.appUrl }),
                        ...(apiConfig.appName && { 'X-Title': apiConfig.appName })
                    },
                    body: JSON.stringify({
                        model: 'openai/gpt-3.5-turbo',
                        messages: [{ role: 'user', content: 'Hello! Just testing the connection.' }],
                        max_tokens: 10
                    })
                });
                
                if (!testResponse.ok) {
                    throw new Error(`Chat API test failed: HTTP ${testResponse.status}`);
                }
                
                await testResponse.json();
                
                // Success!
                apiConfig.isConnected = true;
                updateConnectionStatus('connected', `üü¢ Connected! Found ${popularModels.length} free models available`);
                
                // Restore saved model selection or set default
                if (apiConfig.selectedModel) {
                    // Check if saved model is still available
                    const savedModelExists = popularModels.find(m => m.id === apiConfig.selectedModel);
                    if (savedModelExists) {
                        document.getElementById('selected-model').value = apiConfig.selectedModel;
                    } else {
                        // Saved model not available, select default
                        apiConfig.selectedModel = '';
                    }
                }
                
                // Auto-select a good default free model if none selected
                if (!apiConfig.selectedModel && popularModels.length > 0) {
                    // Prioritize known good free models
                    const defaultModel = popularModels.find(m => 
                        m.id.includes('free') || 
                        m.id.includes('gpt-3.5') ||
                        m.pricing?.prompt === "0" || 
                        m.pricing?.prompt === 0
                    ) || popularModels[0];
                    document.getElementById('selected-model').value = defaultModel.id;
                    apiConfig.selectedModel = defaultModel.id;
                    // Save the default selection
                    localStorage.setItem('openrouter-settings', JSON.stringify(apiConfig));
                }
                
            } catch (error) {
                console.error('Connection test failed:', error);
                apiConfig.isConnected = false;
                updateConnectionStatus('disconnected', `üî¥ Connection failed: ${error.message}`);
            }
        }
        
        // Enable AI assistant functionality
        function enableAIAssistant() {
            const aiAssistant = document.getElementById('ai-assistant');
            const aiPrompt = document.getElementById('ai-prompt');
            const aiBtn = document.getElementById('ai-ask-btn');
            
            aiAssistant.classList.remove('disabled');
            aiPrompt.disabled = false;
            aiBtn.disabled = false;
            aiBtn.textContent = 'Ask AI';
        }
        
        // Ask AI function
        async function askAI() {
            const prompt = document.getElementById('ai-prompt').value.trim();
            if (!prompt) {
                alert('Please enter a question about the property');
                return;
            }
            
            if (!apiConfig.isConnected || !apiConfig.selectedModel) {
                alert('Please configure and test your API connection first');
                return;
            }
            
            const responseEl = document.getElementById('ai-response');
            const aiBtn = document.getElementById('ai-ask-btn');
            
            // Show loading state
            aiBtn.innerHTML = '<span class="loading-spinner"></span> Analyzing...';
            aiBtn.disabled = true;
            responseEl.innerHTML = '<div class="loading-spinner"></div> AI is analyzing your question...';
            responseEl.classList.add('show');
            
            try {
                // Get current property data for context
                const propertyPrice = document.getElementById('property-price').value || 'Not specified';
                const depositPercent = document.getElementById('deposit-percent').value || '5';
                const propertyType = document.getElementById('property-type').value || 'apartment';
                const strataFees = document.getElementById('strata-fees').value || '0';
                
                const totalIncome = userProfile.annualIncome + userProfile.partnerIncome;
                const eligibleSchemes = getEligibleSchemes(userProfile);
                const relationshipStatus = userProfile.relationshipStatus || 'not specified';
                const citizenship = getCitizenshipDisplayText(userProfile.citizenship) || 'not specified';
                const state = getStateDisplayName(userProfile.state) || 'not specified';
                
                const systemPrompt = `You are a helpful first home buyer assistant for someone in Australia. 

Current user profile:
- Status: ${citizenship}
- Income: ${formatIncome(totalIncome)} ${userProfile.partnerIncome > 0 ? 'combined (individual: ' + formatIncome(userProfile.annualIncome) + ', partner: ' + formatIncome(userProfile.partnerIncome) + ')' : 'annually'}
- Currently paying: $${userProfile.currentRent || 0}/month rent
- Relationship status: ${relationshipStatus}
- State: ${state}
- Eligible for ${eligibleSchemes.length} schemes: ${eligibleSchemes.map(s => s.name).join(', ') || 'none'}

Current property being analyzed:
- Price: $${propertyPrice}
- Property type: ${propertyType}
- Deposit: ${depositPercent}%
- Strata fees: $${strataFees}/quarter

Provide helpful, specific advice about this property considering their situation, ${state} market conditions, and their available first home buyer schemes. Be concise but informative.`;
                
                const aiResponse = await retryWithBackoff(async () => {
                    // Rate limiting for AI assistant
                    const now = Date.now();
                    const timeSinceLastCall = now - lastApiCall;
                    if (timeSinceLastCall < API_RATE_LIMIT_MS) {
                        const waitTime = API_RATE_LIMIT_MS - timeSinceLastCall;
                        responseEl.innerHTML = `<div class="loading-spinner"></div> Rate limiting... waiting ${Math.ceil(waitTime/1000)}s`;
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    }
                    
                    lastApiCall = Date.now();
                    
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiConfig.apiKey}`,
                            'Content-Type': 'application/json',
                            ...(apiConfig.appUrl && { 'HTTP-Referer': apiConfig.appUrl }),
                            ...(apiConfig.appName && { 'X-Title': apiConfig.appName })
                        },
                        body: JSON.stringify({
                            model: apiConfig.selectedModel,
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: prompt }
                            ],
                            max_tokens: 400, // Reduced from 500 to save costs
                            temperature: 0.7
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 429) {
                            throw new Error('RATE_LIMIT');
                        } else if (response.status === 401) {
                            throw new Error('UNAUTHORIZED');
                        } else if (response.status >= 500) {
                            throw new Error('SERVER_ERROR');
                        }
                        throw new Error(`API_ERROR_${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.choices?.[0]?.message?.content || 'No response received';
                });
                
                responseEl.innerHTML = `<strong>ü§ñ AI Analysis:</strong><br><br>${aiResponse.replace(/\n/g, '<br>')}`;
                
            } catch (error) {
                console.error('AI request failed:', error);
                responseEl.innerHTML = `<strong>‚ùå Error:</strong> ${error.message}<br><br>Please check your API configuration and try again.`;
            } finally {
                aiBtn.innerHTML = 'Ask AI';
                aiBtn.disabled = false;
            }
        }
        
        // Close settings when clicking outside modal
        document.getElementById('settings-overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettings();
            }
        });
        
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadProfile();
            initializeProfileSettings(); // Initialize accordion state
            updateProfile(); // Initialize schemes display
        });
        
        // Profile Management
        let userProfile = {
            citizenship: '',
            relationshipStatus: '',
            annualIncome: 0,
            partnerIncome: 0,
            currentRent: 0,
            state: 'VIC',
            firstHomeBuyer: 'yes'
        };
        
        // Load profile from localStorage
        function loadProfile() {
            const saved = localStorage.getItem('user-profile');
            if (saved) {
                userProfile = { ...userProfile, ...JSON.parse(saved) };
                
                // Populate form fields
                document.getElementById('citizenship').value = userProfile.citizenship;
                document.getElementById('relationship-status').value = userProfile.relationshipStatus;
                document.getElementById('annual-income').value = userProfile.annualIncome;
                document.getElementById('partner-income').value = userProfile.partnerIncome;
                document.getElementById('current-rent').value = userProfile.currentRent;
                document.getElementById('state').value = userProfile.state;
                document.getElementById('first-home-buyer').value = userProfile.firstHomeBuyer;
                
                // Show partner income field if in relationship
                togglePartnerIncome();
            }
        }
        
        // Save profile to localStorage
        function saveProfile() {
            localStorage.setItem('user-profile', JSON.stringify(userProfile));
        }
        
        // Update profile and refresh schemes
        function updateProfile() {
            // Get form values
            userProfile.citizenship = document.getElementById('citizenship').value;
            userProfile.relationshipStatus = document.getElementById('relationship-status').value;
            userProfile.annualIncome = parseInt(document.getElementById('annual-income').value) || 0;
            userProfile.partnerIncome = parseInt(document.getElementById('partner-income').value) || 0;
            userProfile.currentRent = parseInt(document.getElementById('current-rent').value) || 0;
            userProfile.state = document.getElementById('state').value;
            userProfile.firstHomeBuyer = document.getElementById('first-home-buyer').value;
            
            // Show/hide partner income field
            togglePartnerIncome();
            
            // Update profile summary
            updateProfileSummary();
            
            // Update eligible schemes
            updateEligibleSchemes();
            
            // Update main panel content
            updateMainPanelContent();
            
            // Update accordion summary
            updateProfileQuickSummary();
            
            // Auto-collapse form if profile is complete
            autoManageProfileSettings();
            
            // Save profile
            saveProfile();
        }
        
        // Toggle partner income field visibility
        function togglePartnerIncome() {
            const partnerField = document.getElementById('partner-income-field');
            const showPartnerIncome = userProfile.relationshipStatus === 'couple' || userProfile.relationshipStatus === 'de-facto';
            partnerField.style.display = showPartnerIncome ? 'block' : 'none';
        }
        
        // Update profile summary
        function updateProfileSummary() {
            const totalIncome = userProfile.annualIncome + userProfile.partnerIncome;
            const borrowingEstimate = calculateBorrowingCapacity(totalIncome);
            
            document.getElementById('borrowing-estimate').textContent = borrowingEstimate > 0 ? 
                `$${Math.round(borrowingEstimate/1000)}k` : '$0';
        }
        
        // Calculate borrowing capacity
        function calculateBorrowingCapacity(income) {
            if (income <= 0) return 0;
            // Simplified calculation: roughly 5-6x income depending on circumstances
            const multiplier = income < 80000 ? 5.0 : income < 120000 ? 5.5 : 6.0;
            return income * multiplier;
        }
        
        // Update eligible schemes based on profile
        function updateEligibleSchemes() {
            const schemes = getEligibleSchemes(userProfile);
            const schemesList = document.getElementById('schemes-list');
            const schemesCount = document.getElementById('schemes-count');
            
            if (schemes.length === 0) {
                schemesList.innerHTML = '<div class="no-schemes">Complete your profile to see eligible schemes</div>';
                schemesCount.textContent = '0';
                return;
            }
            
            schemesCount.textContent = schemes.length.toString();
            
            schemesList.innerHTML = schemes.map(scheme => `
                <div class="scheme-item">
                    <div class="scheme-tag">${scheme.type}</div>
                    <h4>${scheme.name}</h4>
                    <p>${scheme.description}</p>
                </div>
            `).join('');
        }
        
        // Get eligible schemes based on profile
        function getEligibleSchemes(profile) {
            const schemes = [];
            const totalIncome = profile.annualIncome + profile.partnerIncome;
            const isCouple = profile.relationshipStatus === 'couple' || profile.relationshipStatus === 'de-facto';
            const isEligibleCitizen = ['australian', 'permanent-resident', 'nz-citizen'].includes(profile.citizenship);
            const isFirstHomeBuyer = ['yes', 'previous-owner'].includes(profile.firstHomeBuyer);
            
            if (!isEligibleCitizen || !isFirstHomeBuyer) {
                return schemes;
            }
            
            // Federal Schemes
            const singleIncomeLimit = 125000;
            const coupleIncomeLimit = 200000;
            const incomeLimit = isCouple ? coupleIncomeLimit : singleIncomeLimit;
            
            if (totalIncome <= incomeLimit) {
                schemes.push({
                    type: 'Federal',
                    name: 'First Home Guarantee',
                    description: '5% deposit, no LMI, available for new and existing homes'
                });
            }
            
            if (totalIncome <= 90000 && !isCouple) {
                schemes.push({
                    type: 'Federal',
                    name: 'Help to Buy',
                    description: '2% deposit, government equity contribution 30-40%'
                });
            } else if (totalIncome <= 120000 && isCouple) {
                schemes.push({
                    type: 'Federal',
                    name: 'Help to Buy',
                    description: '2% deposit, government equity contribution 30-40%'
                });
            }
            
            schemes.push({
                type: 'Federal',
                name: 'First Home Super Saver',
                description: 'Access up to $50K from superannuation for deposit'
            });
            
            // State-specific schemes
            if (profile.state === 'VIC') {
                schemes.push({
                    type: 'Victoria',
                    name: 'Stamp Duty Exemption',
                    description: 'FREE for properties ‚â§$600K, partial exemption $600K-$750K'
                });
                
                schemes.push({
                    type: 'Victoria',
                    name: 'First Home Owner Grant',
                    description: '$10,000 for new homes ‚â§$750K (ending June 2025)'
                });
            } else if (profile.state === 'NSW') {
                schemes.push({
                    type: 'NSW',
                    name: 'First Home Buyers Assistance',
                    description: 'Stamp duty exemption for homes ‚â§$650K'
                });
            } else if (profile.state === 'QLD') {
                schemes.push({
                    type: 'Queensland',
                    name: 'First Home Owner Grant',
                    description: '$15,000 grant for new homes'
                });
            } else if (profile.state === 'SA') {
                schemes.push({
                    type: 'South Australia',
                    name: 'First Home Owner Grant',
                    description: '$15,000 grant for new homes'
                });
            } else if (profile.state === 'WA') {
                schemes.push({
                    type: 'Western Australia',
                    name: 'First Home Owner Grant',
                    description: '$10,000 grant for new and existing homes'
                });
            }
            
            return schemes;
        }
        
        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            
            if (window.innerWidth <= 768) {
                // Mobile: toggle show class
                sidebar.classList.toggle('show');
            } else {
                // Desktop: toggle collapsed class
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('sidebar-collapsed');
            }
        }
        
        // Handle window resize
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            
            if (window.innerWidth > 768) {
                // Desktop mode - remove mobile classes
                sidebar.classList.remove('show');
                if (sidebar.classList.contains('collapsed')) {
                    mainContent.classList.add('sidebar-collapsed');
                } else {
                    mainContent.classList.remove('sidebar-collapsed');
                }
            } else {
                // Mobile mode - reset desktop classes
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('sidebar-collapsed');
            }
        });
        
        // Update all main panel content based on profile
        function updateMainPanelContent() {
            updateProfileStatus();
            updateCostNeutralAnalysis();
        }
        
        // Update profile status section
        function updateProfileStatus() {
            const profileStatusEl = document.getElementById('profile-status');
            
            if (!isProfileComplete()) {
                profileStatusEl.innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3>üëã Welcome to Your First Home Buyer Assistant!</h3>
                        <p style="margin: 15px 0;">Complete your profile in the sidebar to see personalized schemes and recommendations tailored to your situation.</p>
                        <button onclick="toggleSidebar()" style="background: #ffc107; color: #856404; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            Complete Your Profile
                        </button>
                    </div>
                `;
                return;
            }
            
            const totalIncome = userProfile.annualIncome + userProfile.partnerIncome;
            const schemes = getEligibleSchemes(userProfile);
            const isEligible = schemes.length > 0;
            
            if (isEligible) {
                const relationshipText = userProfile.relationshipStatus === 'single' ? 'single buyer' : 
                                       userProfile.relationshipStatus === 'couple' ? 'couple' : 'de facto couple';
                const citizenshipText = getCitizenshipDisplayText(userProfile.citizenship);
                
                profileStatusEl.innerHTML = `
                    <div class="eligibility-status">
                        <h3>üéâ Great News: You're Eligible!</h3>
                        <p>As a ${citizenshipText} ${relationshipText} with ${formatIncome(totalIncome)} combined income in ${getStateDisplayName(userProfile.state)}, you qualify for <strong>${schemes.length} first home buyer scheme${schemes.length > 1 ? 's' : ''}</strong>.</p>
                    </div>
                `;
            } else {
                profileStatusEl.innerHTML = `
                    <div style="background: #fee; border: 1px solid #e74c3c; color: #c0392b; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3>‚ùå Limited Eligibility</h3>
                        <p>Based on your current profile, you may have limited access to first home buyer schemes. Consider reviewing your eligibility criteria or consulting with a mortgage broker.</p>
                    </div>
                `;
            }
        }
        
        
        
        // Update cost-neutral analysis
        function updateCostNeutralAnalysis() {
            const costAnalysisEl = document.getElementById('cost-neutral-analysis');
            const totalIncome = userProfile.annualIncome + userProfile.partnerIncome;
            const currentRent = userProfile.currentRent;
            
            if (totalIncome === 0 || currentRent === 0) {
                costAnalysisEl.innerHTML = `
                    <div style="background: #e9ecef; padding: 30px; border-radius: 15px; text-align: center;">
                        <h3>Complete Your Profile</h3>
                        <p style="margin: 15px 0;">Add your income and current rent to see personalized property recommendations and cost-neutral analysis.</p>
                    </div>
                `;
                return;
            }
            
            const borrowingCapacity = calculateBorrowingCapacity(totalIncome);
            const targetMonthly = currentRent;
            const recommendedPrice = calculateRecommendedPrice(targetMonthly, borrowingCapacity);
            
            costAnalysisEl.innerHTML = `
                <div class="recommendation">
                    <h3>Recommended Purchase Price Range</h3>
                    <div class="price-range">$${Math.round(recommendedPrice.min/1000)}K - $${Math.round(recommendedPrice.max/1000)}K</div>
                    <p>This range keeps total ownership costs similar to your current $${currentRent.toLocaleString()}/month rent${getStateSpecificAdvice()}</p>
                </div>
                
                <div style="background: #ecf0f1; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Your Strategy Points:</h4>
                    <ul style="color: #2c3e50;">
                        ${getPersonalizedStrategyPoints()}
                    </ul>
                </div>
            `;
        }
        
        // Helper functions
        function isProfileComplete() {
            return userProfile.citizenship && 
                   userProfile.relationshipStatus && 
                   userProfile.annualIncome > 0 && 
                   userProfile.state && 
                   userProfile.firstHomeBuyer;
        }
        
        function getCitizenshipDisplayText(citizenship) {
            const citizenshipMap = {
                'australian': 'Australian citizen',
                'permanent-resident': 'permanent resident',
                'nz-citizen': 'New Zealand citizen',
                'other': 'non-resident'
            };
            return citizenshipMap[citizenship] || citizenship;
        }
        
        function getStateDisplayName(stateCode) {
            const stateMap = {
                'NSW': 'New South Wales',
                'VIC': 'Victoria', 
                'QLD': 'Queensland',
                'SA': 'South Australia',
                'WA': 'Western Australia',
                'TAS': 'Tasmania',
                'NT': 'Northern Territory',
                'ACT': 'Australian Capital Territory'
            };
            return stateMap[stateCode] || stateCode;
        }
        
        function formatIncome(income) {
            if (income >= 1000000) {
                return `$${(income/1000000).toFixed(1)}M`;
            } else if (income >= 1000) {
                return `$${Math.round(income/1000)}K`;
            }
            return `$${income.toLocaleString()}`;
        }
        
        function getSchemeDetails(scheme) {
            // Add specific details based on scheme type and user profile
            const details = {
                'First Home Guarantee': [
                    '5% deposit required',
                    'No Lenders Mortgage Insurance',
                    'Available for new and existing homes',
                    userProfile.relationshipStatus === 'single' ? 'Income limit $125K ‚úì' : 'Income limit $200K ‚úì'
                ],
                'Help to Buy': [
                    '2% deposit required',
                    'Government contributes 30-40% equity',
                    'No rent on government share',
                    'Available in major cities'
                ],
                'First Home Super Saver': [
                    'Access up to $50K from superannuation',
                    'Tax advantages on contributions',
                    'Must use for deposit within 12 months',
                    'Available to all eligible citizens'
                ],
                'Stamp Duty Exemption': [
                    userProfile.state === 'VIC' ? 'FREE for properties ‚â§$600K' : 'State-specific thresholds apply',
                    'Partial exemptions available',
                    'Potential savings of $20K+',
                    'Must be first home buyer'
                ],
                'First Home Owner Grant': [
                    'Cash grant for eligible buyers',
                    'State-specific amounts and conditions',
                    'Must live in property for specified period',
                    'New home requirements may apply'
                ]
            };
            
            const schemeDetails = details[scheme.name] || [scheme.description];
            
            return `
                <ul>
                    ${schemeDetails.map(detail => `<li>${detail}</li>`).join('')}
                </ul>
            `;
        }
        
        function calculateRecommendedPrice(monthlyBudget, maxBorrowing) {
            // Calculate based on monthly budget and borrowing capacity
            const estimatedMonthlyRepayment = monthlyBudget * 0.7; // 70% for loan, 30% for other costs
            const estimatedLoanAmount = estimatedMonthlyRepayment * 300; // Rough calculation for 30-year loan
            
            const budgetBasedMax = estimatedLoanAmount / 0.95; // Assuming 5% deposit
            const borrowingBasedMax = maxBorrowing / 0.95;
            
            const maxPrice = Math.min(budgetBasedMax, borrowingBasedMax);
            const minPrice = maxPrice * 0.8;
            
            return {
                min: Math.max(minPrice, 400000), // Minimum realistic price
                max: Math.min(maxPrice, 1000000) // Maximum recommended price
            };
        }
        
        function getStateSpecificAdvice() {
            if (userProfile.state === 'VIC') {
                return ' and maximizes Victoria\'s stamp duty exemptions';
            } else if (userProfile.state === 'NSW') {
                return ' and takes advantage of NSW first home buyer assistance';
            }
            return '';
        }
        
        function getPersonalizedStrategyPoints() {
            const points = [];
            const schemes = getEligibleSchemes(userProfile);
            
            // State-specific advice
            if (userProfile.state === 'VIC') {
                points.push('<li style="margin: 10px 0;">Focus on properties under $600K for maximum stamp duty savings in Victoria</li>');
            }
            
            // Scheme-specific advice
            const hasHelpToBuy = schemes.some(s => s.name === 'Help to Buy');
            const hasFirstHomeGuarantee = schemes.some(s => s.name === 'First Home Guarantee');
            
            if (hasHelpToBuy) {
                points.push('<li style="margin: 10px 0;">Consider the Help to Buy scheme for 2% deposit with government equity</li>');
            } else if (hasFirstHomeGuarantee) {
                points.push('<li style="margin: 10px 0;">Use First Home Guarantee for 5% deposit without LMI</li>');
            }
            
            points.push('<li style="margin: 10px 0;">Factor in all ongoing costs when calculating affordability</li>');
            points.push('<li style="margin: 10px 0;">Get pre-approval to understand exact borrowing capacity</li>');
            
            return points.join('');
        }
        
        // Profile Settings Accordion Functions
        function toggleProfileSettings() {
            const container = document.getElementById('profile-form-container');
            const toggle = document.getElementById('profile-settings-toggle');
            
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                container.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }
        
        // Update the quick summary in the accordion header
        function updateProfileQuickSummary() {
            const summaryEl = document.getElementById('profile-quick-summary');
            const isComplete = isProfileComplete();
            
            if (!isComplete) {
                summaryEl.innerHTML = '<div class="summary-item" style="color: #856404;">‚ö†Ô∏è Profile incomplete</div>';
                return;
            }
            
            const totalIncome = userProfile.annualIncome + userProfile.partnerIncome;
            const summaryItems = [];
            
            if (userProfile.citizenship) {
                summaryItems.push(`<div class="summary-item">${getCitizenshipDisplayText(userProfile.citizenship)}</div>`);
            }
            
            if (userProfile.relationshipStatus) {
                summaryItems.push(`<div class="summary-item">${capitalizeFirst(userProfile.relationshipStatus)}</div>`);
            }
            
            if (totalIncome > 0) {
                summaryItems.push(`<div class="summary-item">${formatIncome(totalIncome)} income</div>`);
            }
            
            if (userProfile.state) {
                summaryItems.push(`<div class="summary-item">${userProfile.state}</div>`);
            }
            
            summaryEl.innerHTML = summaryItems.join('');
        }
        
        // Auto-manage profile settings visibility
        function autoManageProfileSettings() {
            const container = document.getElementById('profile-form-container');
            const toggle = document.getElementById('profile-settings-toggle');
            const isComplete = isProfileComplete();
            
            // If profile was just completed and form is open, close it after a brief delay
            if (isComplete && container.classList.contains('expanded')) {
                setTimeout(() => {
                    container.classList.remove('expanded');
                    toggle.classList.remove('expanded');
                }, 1000); // Wait 1 second before auto-closing
            }
            
            // If profile is incomplete, ensure form is open
            if (!isComplete && !container.classList.contains('expanded')) {
                container.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }
        
        // Initialize profile settings state
        function initializeProfileSettings() {
            const isComplete = isProfileComplete();
            const container = document.getElementById('profile-form-container');
            const toggle = document.getElementById('profile-settings-toggle');
            
            // Show form if profile is incomplete, hide if complete
            if (!isComplete) {
                container.classList.add('expanded');
                toggle.classList.add('expanded');
            } else {
                container.classList.remove('expanded');
                toggle.classList.remove('expanded');
            }
            
            updateProfileQuickSummary();
        }
        
        // Helper function to capitalize first letter
        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        // Property Web Scraping and Cost Estimation
        async function fetchPropertyDetails() {
            const url = document.getElementById('property-url').value.trim();
            if (!url) {
                updateFetchStatus('‚ùå Please enter a property URL', 'error');
                return;
            }
            
            const fetchBtn = document.getElementById('fetch-btn');
            const originalText = fetchBtn.textContent;
            
            try {
                fetchBtn.innerHTML = '<span class="loading-spinner"></span> Fetching...';
                fetchBtn.disabled = true;
                updateFetchStatus('üîÑ Analyzing property listing...', 'loading');
                
                // Extract property details using multiple approaches
                const propertyData = await extractPropertyData(url);
                
                if (propertyData.success) {
                    // Populate form fields with extracted data
                    if (propertyData.price) {
                        document.getElementById('property-price').value = propertyData.price;
                    }
                    
                    if (propertyData.address) {
                        document.getElementById('property-address').value = propertyData.address;
                    }
                    
                    if (propertyData.propertyType) {
                        document.getElementById('property-type').value = propertyData.propertyType;
                        // Trigger change event to update strata fees
                        document.getElementById('property-type').dispatchEvent(new Event('change'));
                    }
                    
                    // If we got strata fees from the webpage, use those instead of estimates
                    if (propertyData.strataFees) {
                        // Extract numeric value from string like "$1,500/quarter" or "1500"
                        const strataMatch = propertyData.strataFees.match(/[\d,]+/);
                        if (strataMatch) {
                            const strataValue = strataMatch[0].replace(/,/g, '');
                            document.getElementById('strata-fees').value = strataValue;
                        }
                    }
                    
                    // Look up real council rates and strata fees from public sources
                    updateFetchStatus('üîÑ Searching council databases and public records...', 'loading');
                    const publicData = await searchPublicPropertyData(propertyData);
                    
                    // Update cost fields with real public data
                    if (publicData.councilRates) {
                        // Council rates found - show in status or store for calculation
                        console.log('Found council rates:', publicData.councilRates);
                    }
                    
                    if (publicData.strataFees && !propertyData.strataFees) {
                        // Only update if we didn't get strata fees from the listing
                        document.getElementById('strata-fees').value = publicData.strataFees;
                    }
                    
                    // Show comprehensive success message with all data sources
                    const dataSourceInfo = [];
                    
                    if (propertyData.dataSource === 'webpage_content') {
                        dataSourceInfo.push('Property listing');
                    } else {
                        dataSourceInfo.push('Estimated property');
                    }
                    
                    if (publicData.councilRates) {
                        dataSourceInfo.push(`Council rates: $${publicData.councilRates}/year`);
                    }
                    
                    if (publicData.strataFees) {
                        dataSourceInfo.push(`Strata fees: $${publicData.strataFees}/quarter`);
                    }
                    
                    if (publicData.dataSource && publicData.dataSource.length > 0) {
                        dataSourceInfo.push(`Sources: ${publicData.dataSource.join(', ')}`);
                    }
                    
                    const successMessage = `‚úÖ Complete property data! Price: $${propertyData.price?.toLocaleString() || 'N/A'} | ${dataSourceInfo.join(' | ')}`;
                    
                    updateFetchStatus(successMessage, 'success');
                    
                    // Show any additional insights
                    const allInsights = [];
                    if (propertyData.aiInsights && propertyData.aiInsights.trim()) {
                        allInsights.push(propertyData.aiInsights);
                    }
                    
                    if (allInsights.length > 0) {
                        setTimeout(() => {
                            updateFetchStatus(successMessage + `\nüí° ${allInsights.join(' ‚Ä¢ ')}`, 'success');
                        }, 3000);
                    }
                    
                    // Auto-calculate costs
                    setTimeout(() => {
                        calculateCosts();
                    }, 1000);
                    
                } else {
                    updateFetchStatus(`‚ùå ${propertyData.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Property fetch error:', error);
                
                // Provide helpful error messages
                let errorMessage = '';
                if (error.message.includes('Invalid API key')) {
                    errorMessage = '‚ùå API Key Issue: Please check your OpenRouter API configuration in settings';
                } else if (error.message.includes('Maximum retry attempts exceeded')) {
                    errorMessage = '‚ö†Ô∏è Using Smart Fallback: API temporarily unavailable, estimated property details from URL patterns';
                    // Still try to get fallback data
                    try {
                        const fallbackData = await extractPropertyDataFallback(url);
                        if (fallbackData.success) {
                            // Populate form with fallback data
                            if (fallbackData.price) {
                                document.getElementById('property-price').value = fallbackData.price;
                            }
                            if (fallbackData.address) {
                                document.getElementById('property-address').value = fallbackData.address;
                            }
                            if (fallbackData.propertyType) {
                                document.getElementById('property-type').value = fallbackData.propertyType;
                                document.getElementById('property-type').dispatchEvent(new Event('change'));
                            }
                            
                            updateFetchStatus(`‚úÖ Fallback successful! Estimated: ${fallbackData.suburb || 'property details'} (API unavailable, using URL analysis)`, 'success');
                            setTimeout(() => calculateCosts(), 1000);
                            return;
                        }
                    } catch (fallbackError) {
                        errorMessage = '‚ùå Unable to extract property details. Please enter manually or try a different URL';
                    }
                } else if (error.message.includes('rate limit') || error.message.includes('429')) {
                    errorMessage = '‚è∞ Rate Limited: Please wait a moment and try again. Consider using fewer API calls to avoid limits';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                updateFetchStatus(errorMessage, 'error');
            } finally {
                fetchBtn.textContent = originalText;
                fetchBtn.disabled = false;
            }
        }
        
        // Extract property data from URL using AI and web scraping
        async function extractPropertyData(url) {
            try {
                // First, try to use OpenRouter API for web scraping if available
                if (apiConfig.isConnected && apiConfig.selectedModel) {
                    return await extractPropertyDataWithAI(url);
                } else {
                    // Fallback to pattern matching and estimation
                    return await extractPropertyDataFallback(url);
                }
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
        
        // Rate limiting for API calls
        let lastApiCall = 0;
        const API_RATE_LIMIT_MS = 2000; // 2 seconds between calls
        
        // AI-powered property data extraction with retry logic
        async function extractPropertyDataWithAI(url) {
            return await retryWithBackoff(async () => {
                // Rate limiting - ensure minimum time between calls
                const now = Date.now();
                const timeSinceLastCall = now - lastApiCall;
                if (timeSinceLastCall < API_RATE_LIMIT_MS) {
                    const waitTime = API_RATE_LIMIT_MS - timeSinceLastCall;
                    updateFetchStatus(`üîÑ Rate limiting... waiting ${Math.ceil(waitTime/1000)}s`, 'loading');
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
                
                lastApiCall = Date.now();
                
                const systemPrompt = `You are a property data extraction expert. I will provide you with the HTML content from an Australian property listing webpage, and you need to extract key property information.

Please analyze the webpage content and provide a JSON response with the following structure:
{
  "price": number (property price in dollars, extract the exact listing price),
  "address": "string (full property address)",
  "propertyType": "house|apartment|townhouse",
  "bedrooms": number,
  "bathrooms": number,
  "suburb": "string",
  "postcode": "string",
  "parkingSpaces": number,
  "landSize": "string (if available)",
  "buildingArea": "string (if available)",
  "councilRates": "string (if mentioned)",
  "strataFees": "string (if mentioned)",
  "features": ["array of key features"]
}

Look for exact prices, addresses, and any mention of ongoing costs like council rates or strata fees. Be precise with the data you extract.`;
                
                // Try to fetch webpage content using a CORS proxy
                updateFetchStatus('üîÑ Fetching webpage content...', 'loading');
                
                let webpageContent = '';
                let fetchMethod = 'proxy';
                
                try {
                    // Try using a public CORS proxy
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const webpageResponse = await fetch(proxyUrl);
                    
                    if (webpageResponse.ok) {
                        webpageContent = await webpageResponse.text();
                        updateFetchStatus('‚úÖ Webpage content fetched successfully', 'success');
                    } else {
                        throw new Error('Proxy fetch failed');
                    }
                } catch (fetchError) {
                    console.log('CORS proxy fetch failed:', fetchError);
                    fetchMethod = 'fallback';
                    updateFetchStatus('‚ö†Ô∏è Direct fetch failed, using AI analysis...', 'warning');
                }
                
                const userPrompt = webpageContent ? 
                    `Extract property details from this Australian property listing webpage:\n\nURL: ${url}\n\nHTML Content (first 4000 chars):\n${webpageContent.substring(0, 4000)}\n\nPlease extract the exact price and property details from this content.` :
                    `I need help with this Australian property listing URL: ${url}\n\nThis appears to be a ${url.includes('apartment') ? 'apartment' : url.includes('house') ? 'house' : 'property'} listing in ${url.includes('preston') ? 'Preston' : 'Melbourne'}, VIC.\n\nSince I cannot access the webpage content, please provide realistic estimates for this type of property in this location based on current market conditions.`;
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiConfig.apiKey}`,
                        'Content-Type': 'application/json',
                        ...(apiConfig.appUrl && { 'HTTP-Referer': apiConfig.appUrl }),
                        ...(apiConfig.appName && { 'X-Title': apiConfig.appName })
                    },
                    body: JSON.stringify({
                        model: apiConfig.selectedModel,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        max_tokens: 600, // Reduced from 800 to save costs
                        temperature: 0.1
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => '');
                    if (response.status === 429) {
                        throw new Error('RATE_LIMIT');
                    } else if (response.status === 401) {
                        throw new Error('UNAUTHORIZED');
                    } else if (response.status >= 500) {
                        throw new Error('SERVER_ERROR');
                    }
                    throw new Error(`API_ERROR_${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices?.[0]?.message?.content || '';
                
                // Try to extract JSON from AI response
                const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    try {
                        const extractedData = JSON.parse(jsonMatch[0]);
                        
                        // Validate that we have reasonable data
                        const result = {
                            success: true,
                            price: extractedData.price || null,
                            address: extractedData.address || null,
                            propertyType: extractedData.propertyType || 'apartment',
                            bedrooms: extractedData.bedrooms || null,
                            bathrooms: extractedData.bathrooms || null,
                            suburb: extractedData.suburb || null,
                            postcode: extractedData.postcode || null,
                            parkingSpaces: extractedData.parkingSpaces || null,
                            landSize: extractedData.landSize || null,
                            buildingArea: extractedData.buildingArea || null,
                            councilRates: extractedData.councilRates || null,
                            strataFees: extractedData.strataFees || null,
                            features: extractedData.features || [],
                            aiInsights: aiResponse.replace(jsonMatch[0], '').trim(),
                            dataSource: webpageContent ? 'webpage_content' : 'ai_estimate'
                        };
                        
                        updateFetchStatus(webpageContent ? 
                            '‚úÖ Property data extracted from webpage' : 
                            '‚ö†Ô∏è Property data estimated (webpage not accessible)', 
                            webpageContent ? 'success' : 'warning'
                        );
                        
                        return result;
                    } catch (e) {
                        console.error('JSON parsing failed:', e);
                        updateFetchStatus('‚ùå Failed to parse AI response', 'error');
                    }
                }
                
                // If AI extraction fails, use fallback
                updateFetchStatus('‚ö†Ô∏è AI extraction failed, using fallback estimates', 'warning');
                return await extractPropertyDataFallback(url);
            });
        }
        
        // Retry with exponential backoff
        async function retryWithBackoff(apiCall, maxRetries = 3) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    return await apiCall();
                } catch (error) {
                    console.log(`Attempt ${attempt + 1} failed:`, error.message);
                    
                    if (error.message === 'RATE_LIMIT') {
                        const backoffTime = Math.min(1000 * Math.pow(2, attempt), 8000); // Max 8 seconds
                        updateFetchStatus(`üîÑ Rate limited. Retrying in ${Math.ceil(backoffTime/1000)}s... (${attempt + 1}/${maxRetries})`, 'loading');
                        await new Promise(resolve => setTimeout(resolve, backoffTime));
                        continue;
                    }
                    
                    if (error.message === 'UNAUTHORIZED') {
                        throw new Error('Invalid API key. Please check your OpenRouter API configuration.');
                    }
                    
                    if (error.message === 'SERVER_ERROR') {
                        const backoffTime = Math.min(2000 * Math.pow(2, attempt), 10000);
                        updateFetchStatus(`üîÑ Server error. Retrying in ${Math.ceil(backoffTime/1000)}s... (${attempt + 1}/${maxRetries})`, 'loading');
                        await new Promise(resolve => setTimeout(resolve, backoffTime));
                        continue;
                    }
                    
                    // For other errors, don't retry
                    throw error;
                }
            }
            
            throw new Error('Maximum retry attempts exceeded. Using fallback property detection.');
        }
        
        // Fallback property data extraction using URL patterns
        async function extractPropertyDataFallback(url) {
            let propertyData = {
                success: true,
                price: null,
                address: null,
                propertyType: 'apartment',
                suburb: null,
                postcode: null
            };
            
            // Extract information from URL patterns
            const urlLower = url.toLowerCase();
            
            // Detect property type from URL
            if (urlLower.includes('house') || urlLower.includes('cottage') || urlLower.includes('villa')) {
                propertyData.propertyType = 'house';
            } else if (urlLower.includes('townhouse') || urlLower.includes('terrace')) {
                propertyData.propertyType = 'townhouse';
            } else {
                propertyData.propertyType = 'apartment';
            }
            
            // Extract suburb from common URL patterns
            const suburbMatch = url.match(/\/([a-z-]+)-vic-(\d{4})/i) || url.match(/\/([a-z-]+)-(\d{4})/i);
            if (suburbMatch) {
                propertyData.suburb = suburbMatch[1].replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                propertyData.postcode = suburbMatch[2];
                propertyData.address = `${propertyData.suburb} VIC ${propertyData.postcode}`;
            }
            
            // Provide estimated price ranges for Melbourne suburbs (fallback)
            if (!propertyData.price && propertyData.suburb) {
                propertyData.price = estimatePriceBySuburb(propertyData.suburb, propertyData.propertyType);
            }
            
            return propertyData;
        }
        
        // Estimate property costs based on extracted data
        async function estimatePropertyCosts(propertyData) {
            const costs = {
                strataFees: 0,
                councilRates: 2400, // Default Melbourne average
                insurance: 2000,
                estimatedMaintenance: 0
            };
            
            // Estimate strata fees based on property type and location
            if (propertyData.propertyType === 'apartment') {
                // Higher strata fees for CBD and inner suburbs
                const innerSuburbs = ['melbourne', 'carlton', 'fitzroy', 'collingwood', 'south yarra', 'toorak'];
                const isInner = innerSuburbs.some(suburb => 
                    propertyData.suburb?.toLowerCase().includes(suburb) || 
                    propertyData.address?.toLowerCase().includes(suburb)
                );
                
                costs.strataFees = isInner ? 2000 : 1500; // Quarterly
            } else if (propertyData.propertyType === 'townhouse') {
                costs.strataFees = 800; // Quarterly
            }
            
            // Estimate maintenance based on property type and price
            if (propertyData.price) {
                const maintenanceRate = propertyData.propertyType === 'house' ? 0.015 : 0.01;
                costs.estimatedMaintenance = propertyData.price * maintenanceRate;
            }
            
            return costs;
        }
        
        // Estimate price by suburb (Melbourne suburbs)
        function estimatePriceBySuburb(suburb, propertyType) {
            const suburbPrices = {
                'melbourne': { apartment: 650000, house: 1200000, townhouse: 850000 },
                'carlton': { apartment: 580000, house: 1100000, townhouse: 800000 },
                'fitzroy': { apartment: 620000, house: 1300000, townhouse: 900000 },
                'collingwood': { apartment: 600000, house: 1200000, townhouse: 850000 },
                'south yarra': { apartment: 750000, house: 1800000, townhouse: 1100000 },
                'toorak': { apartment: 900000, house: 2500000, townhouse: 1500000 },
                'richmond': { apartment: 550000, house: 1100000, townhouse: 800000 },
                'brunswick': { apartment: 500000, house: 900000, townhouse: 700000 },
                'coburg': { apartment: 450000, house: 800000, townhouse: 650000 },
                'preston': { apartment: 420000, house: 750000, townhouse: 600000 },
                'northcote': { apartment: 530000, house: 950000, townhouse: 750000 },
                'kew': { apartment: 650000, house: 1600000, townhouse: 1000000 },
                'hawthorn': { apartment: 600000, house: 1400000, townhouse: 950000 },
                'malvern': { apartment: 650000, house: 1500000, townhouse: 1000000 },
                'st kilda': { apartment: 520000, house: 1100000, townhouse: 800000 },
                'elwood': { apartment: 580000, house: 1200000, townhouse: 850000 }
            };
            
            const suburbKey = suburb.toLowerCase().replace(/\s+/g, ' ');
            const prices = suburbPrices[suburbKey];
            
            if (prices && prices[propertyType]) {
                return prices[propertyType];
            }
            
            // Default Melbourne averages
            const defaults = { apartment: 550000, house: 1000000, townhouse: 750000 };
            return defaults[propertyType] || 550000;
        }
        
        // Search public databases and council websites for property data
        async function searchPublicPropertyData(propertyData) {
            const results = {
                councilRates: null,
                strataFees: null,
                landValue: null,
                dataSource: []
            };
            
            if (!apiConfig.isConnected || !apiConfig.selectedModel) {
                console.log('AI not configured, skipping public data search');
                return results;
            }
            
            try {
                // Rate limiting
                const now = Date.now();
                const timeSinceLastCall = now - lastApiCall;
                if (timeSinceLastCall < API_RATE_LIMIT_MS) {
                    const waitTime = API_RATE_LIMIT_MS - timeSinceLastCall;
                    updateFetchStatus(`üîÑ Rate limiting... waiting ${Math.ceil(waitTime/1000)}s`, 'loading');
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
                lastApiCall = Date.now();
                
                const address = propertyData.address || `${propertyData.suburb} VIC ${propertyData.postcode}`;
                const suburb = propertyData.suburb || 'Melbourne';
                const postcode = propertyData.postcode || '';
                
                const systemPrompt = `You are a property research assistant specializing in finding public property data in Australia.

Your task is to help locate council rates, strata fees, and property values by identifying the right public sources and what data might be available.

Respond with JSON:
{
  "councilName": "string (local council name)",
  "councilWebsite": "string (council website if known)",
  "ratesEstimate": "string (estimated annual rates if calculable)",
  "strataFeesRange": "string (typical strata fees for this type/area)",
  "publicDataSources": ["array of relevant public data sources"],
  "searchRecommendations": "string (how to find exact rates for this property)"
}

Be specific about Victorian councils and provide realistic estimates based on location and property type.`;
                
                const userPrompt = `Find public property data for:
Address: ${address}
Property Type: ${propertyData.propertyType || 'apartment'}
Suburb: ${suburb}
Postcode: ${postcode}

I need to find:
1. Council rates (annual amount)
2. Strata fees for apartment/unit (quarterly)
3. Land value if available

What council handles this area and what are realistic estimates based on the location and property type?`;
                
                updateFetchStatus('üîç AI searching public databases...', 'loading');
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiConfig.apiKey}`,
                        'Content-Type': 'application/json',
                        ...(apiConfig.appUrl && { 'HTTP-Referer': apiConfig.appUrl }),
                        ...(apiConfig.appName && { 'X-Title': apiConfig.appName })
                    },
                    body: JSON.stringify({
                        model: apiConfig.selectedModel,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        max_tokens: 400,
                        temperature: 0.1
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices?.[0]?.message?.content || '';
                
                // Try to extract JSON from AI response
                const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    try {
                        const publicData = JSON.parse(jsonMatch[0]);
                        
                        // Extract numeric values from estimates
                        if (publicData.ratesEstimate) {
                            const ratesMatch = publicData.ratesEstimate.match(/[\d,]+/);
                            if (ratesMatch) {
                                results.councilRates = parseInt(ratesMatch[0].replace(/,/g, ''));
                            }
                        }
                        
                        if (publicData.strataFeesRange) {
                            const strataMatch = publicData.strataFeesRange.match(/[\d,]+/);
                            if (strataMatch) {
                                results.strataFees = parseInt(strataMatch[0].replace(/,/g, ''));
                            }
                        }
                        
                        results.dataSource.push(`Council: ${publicData.councilName || 'Unknown'}`);
                        if (publicData.publicDataSources) {
                            results.dataSource.push(...publicData.publicDataSources);
                        }
                        
                        updateFetchStatus(`üìä Found council data: ${publicData.councilName || suburb} Council`, 'success');
                        
                        // Stage 2: Try to fetch actual data from council website if available
                        if (publicData.councilWebsite && publicData.councilWebsite.includes('http')) {
                            try {
                                updateFetchStatus('üåê Accessing council website for exact rates...', 'loading');
                                
                                const councilData = await fetchCouncilData(publicData.councilWebsite, address, publicData.councilName);
                                
                                if (councilData.councilRates) {
                                    results.councilRates = councilData.councilRates;
                                    results.dataSource.push('Council Website Direct');
                                }
                                
                            } catch (councilError) {
                                console.log('Council website access failed:', councilError);
                                updateFetchStatus(`üìä Council data estimated (direct access failed)`, 'warning');
                            }
                        }
                        
                        return results;
                    } catch (e) {
                        console.error('Failed to parse public data response:', e);
                    }
                }
                
            } catch (error) {
                console.error('Public data search failed:', error);
                updateFetchStatus('‚ö†Ô∏è Public data search unavailable', 'warning');
            }
            
            return results;
        }
        
        // Fetch actual data from council websites
        async function fetchCouncilData(councilWebsite, address, councilName) {
            const results = {
                councilRates: null,
                dataFound: false
            };
            
            try {
                // Rate limiting
                const now = Date.now();
                const timeSinceLastCall = now - lastApiCall;
                if (timeSinceLastCall < API_RATE_LIMIT_MS) {
                    const waitTime = API_RATE_LIMIT_MS - timeSinceLastCall;
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
                lastApiCall = Date.now();
                
                // Try to fetch council website content via CORS proxy
                let councilContent = '';
                try {
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(councilWebsite)}`;
                    const councilResponse = await fetch(proxyUrl);
                    
                    if (councilResponse.ok) {
                        councilContent = await councilResponse.text();
                        console.log('Council website content fetched');
                    }
                } catch (fetchError) {
                    console.log('Council website fetch failed:', fetchError);
                }
                
                // Use AI to analyze council website and look for property rates
                if (councilContent || councilWebsite) {
                    const systemPrompt = `You are a property rates specialist. Analyze council website content or help navigate to property rates information.

Look for:
- Property rates calculators
- Rate notices information  
- Property valuation data
- Links to rates search tools

Respond with JSON:
{
  "ratesFound": boolean,
  "annualRates": number (if found),
  "ratesSearchUrl": "string (URL to rates search tool)",
  "instructions": "string (how to find rates for this property)"
}`;
                    
                    const userPrompt = councilContent ? 
                        `Analyze this ${councilName} council website content for property rates information:\n\nWebsite: ${councilWebsite}\nProperty Address: ${address}\n\nContent:\n${councilContent.substring(0, 3000)}` :
                        `Help me find property rates for ${address} on ${councilName} council website: ${councilWebsite}\n\nWhat should I look for and where can I find property rates information on this council's website?`;
                    
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiConfig.apiKey}`,
                            'Content-Type': 'application/json',
                            ...(apiConfig.appUrl && { 'HTTP-Referer': apiConfig.appUrl }),
                            ...(apiConfig.appName && { 'X-Title': apiConfig.appName })
                        },
                        body: JSON.stringify({
                            model: apiConfig.selectedModel,
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: userPrompt }
                            ],
                            max_tokens: 300,
                            temperature: 0.1
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const aiResponse = data.choices?.[0]?.message?.content || '';
                        
                        const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            try {
                                const councilData = JSON.parse(jsonMatch[0]);
                                
                                if (councilData.ratesFound && councilData.annualRates) {
                                    results.councilRates = councilData.annualRates;
                                    results.dataFound = true;
                                    updateFetchStatus(`‚úÖ Found exact rates from ${councilName}: $${councilData.annualRates}/year`, 'success');
                                } else if (councilData.ratesSearchUrl) {
                                    updateFetchStatus(`üîó Found rates search tool: ${councilData.ratesSearchUrl}`, 'info');
                                }
                                
                                return results;
                            } catch (e) {
                                console.error('Council data parsing failed:', e);
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Council data fetch failed:', error);
            }
            
            return results;
        }
        
        // Update fetch status display
        function updateFetchStatus(message, type = 'info') {
            const statusEl = document.getElementById('property-fetch-status');
            statusEl.textContent = message;
            statusEl.style.color = type === 'success' ? '#27ae60' : 
                                 type === 'error' ? '#e74c3c' : 
                                 type === 'loading' ? '#f39c12' : '#fff';
        }
    </script>
</body>
</html>